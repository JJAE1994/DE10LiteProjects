library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
--use IEEE.STD_LOGIC_UNSIGNED.ALL;

entity SPI_FSM is
port ( 	clk, medir, reset, MISO: in std_logic;
       	MOSI, CS: out std_logic;
			dato_rx: out std_logic_vector(7 downto 0)
		);
end SPI_FSM;

architecture Behavioral of SPI_FSM is

type state is (idle, b7,b6,b5,b4,b3,b2,b1,b0, fintx, a7, a6, a5, a4, a3, a2, a1, a0, fin);

signal instr_leer: std_logic_vector(7 downto 0):= X"05";
signal dato: std_logic_vector(7 downto 0);
signal s_cs, s_mosi: std_logic:='1';
signal pr_state : state := idle;
signal nx_state: state;

begin

process(clk, reset)
begin

	if reset='1' then
		pr_state <= idle;
	elsif clk'event and clk='1' then
		pr_state <= nx_state;
	end if;
end process;

-- Seccion superior
process(pr_state, medir, instr_leer, MISO, dato)
begin
	case pr_state is
		when idle=>
			s_mosi<='1';
			s_cs<='1';
			if medir='1' then
				s_cs<='0';
				nx_state<=b7;
			else 
				nx_state<=idle;
			end if;
			
		when b7=>
			s_mosi<=instr_leer(7);
			nx_state<=b6;
			
		when b6=>
			s_mosi<=instr_leer(6);
			nx_state<=b5;
			
		when b5=>
			s_mosi<=instr_leer(5);
			nx_state<=b4;			
			
		when b4=>
			s_mosi<=instr_leer(4);
			nx_state<=b3;				
			
		when b3=>
			s_mosi<=instr_leer(3);
			nx_state<=b2;			
			
		when b2=>
			s_mosi<=instr_leer(2);
			nx_state<=b1;				
			
		when b1=>
			s_mosi<=instr_leer(1);
			nx_state<=b0;	
			
		when b0=>
			s_mosi<=instr_leer(0);
			nx_state<=fintx;
			
		when fintx=>
			s_mosi<='1';
			if MISO='1' then
				nx_state<=fintx;
			elsif MISO ='0' then
				dato(7) <= MISO;
				nx_state<=a6;
			end if;
			
		when a7=>
			s_cs<='0';
			dato(7) <= MISO; 
			nx_state<=a6;
			
		when a6=>
			dato(6) <= MISO;
			nx_state<=a5;
			
		when a5=>
			dato(5) <= MISO;
			nx_state<=a4;	
			
		when a4=>
			dato(4) <= MISO;
			nx_state<=a3;			
			
		when a3=>
			dato(3) <= MISO;
			nx_state<=a2;		
			
		when a2=>
			dato(2) <= MISO;
			nx_state<=a1;			
			
		when a1=>
			dato(1) <= MISO;
			nx_state<=a0;

		when a0=>
			dato(0) <= MISO;
			nx_state<=fin;
			
		when fin=>			
			s_cs<='1';
			dato_rx <= dato;		
			nx_state<=idle;			
			
			
	end case;
end process;

MOSI <= 
			'Z' when s_cs='1' else
			s_mosi;

CS<=s_cs;
						
end Behavioral; 
